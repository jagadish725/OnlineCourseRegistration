<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online Course Registration System</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div class="login-container">
        <div class="login-box">
            <div class="login-left">
                <h1>ðŸ“š Online Course Registration System</h1>
                <p>Welcome to the Online Course Registration System. Manage your academic journey with ease. Enroll in courses, view your schedule, and track your progress all in one place.</p>
                <br>
                <p><strong>Features:</strong></p>
                <ul style="margin-left: 20px; margin-top: 10px;">
                    <li>Browse available courses</li>
                    <li>Enroll and drop courses</li>
                    <li>View your schedule</li>
                    <li>Track academic progress</li>
                    <li>Access course information</li>
                </ul>
            </div>
            
            <div class="login-right">
                <div class="tab-buttons">
                    <button class="tab-btn active" onclick="switchTab('student')">Student</button>
                    <button class="tab-btn" onclick="switchTab('admin')">Admin</button>
                </div>

                <div id="alertBox" class="alert"></div>

                <!-- Student Login Form -->
                <form id="studentLoginForm" class="login-form active">
                    <h2 style="margin-bottom: 20px; color: #2c3e50;">Student Login</h2>
                    
                    <div class="form-group">
                        <label for="studentEmail">Email</label>
                        <input type="email" id="studentEmail" placeholder="your.email@student.edu" required>
                    </div>

                    <div class="form-group">
                        <label for="studentPassword">Password</label>
                        <input type="password" id="studentPassword" placeholder="Enter your password" required>
                    </div>

                    <button type="submit" class="btn btn-primary">Login</button>

                    <p style="text-align: center; margin-top: 15px; color: #7f8c8d;">
                        <small>Don't have an account? <a href="#" onclick="showRegisterForm(); return false;" style="color: #3498db; text-decoration: underline;">Register here</a></small>
                    </p>

                    <p style="text-align: center; margin-top: 10px; color: #7f8c8d;">
                        <small>Demo: alice.anderson@student.edu / student123</small>
                    </p>
                </form>

                <!-- Student Registration Form -->
                <form id="studentRegisterForm" class="login-form" style="display: none;">
                    <h2 style="margin-bottom: 20px; color: #2c3e50;">Student Registration</h2>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="regFirstName">First Name *</label>
                            <input type="text" id="regFirstName" placeholder="John" required>
                        </div>
                        <div class="form-group">
                            <label for="regLastName">Last Name *</label>
                            <input type="text" id="regLastName" placeholder="Doe" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="regStudentNumber">Student Number *</label>
                        <input type="text" id="regStudentNumber" placeholder="STU2025006" required>
                    </div>

                    <div class="form-group">
                        <label for="regEmail">Email *</label>
                        <input type="email" id="regEmail" placeholder="john.doe@student.edu" required>
                    </div>

                    <div class="form-group">
                        <label for="regPassword">Password *</label>
                        <input type="password" id="regPassword" placeholder="Minimum 6 characters" required minlength="6">
                    </div>

                    <div class="form-group">
                        <label for="regPhone">Phone</label>
                        <input type="tel" id="regPhone" placeholder="555-1234" maxlength="10" inputmode="numeric" pattern="[0-9]{0,10}" title="Up to 10 digits" />
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="regDOB">Date of Birth</label>
                            <input type="date" id="regDOB">
                        </div>
                        <div class="form-group">
                            <label for="regGender">Gender</label>
                            <select id="regGender">
                                <option value="">Select</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="regDepartment">Department *</label>
                        <select id="regDepartment" required>
                            <option value="">Select Department</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="regYear">Enrollment Year *</label>
                        <input type="number" id="regYear" placeholder="2025" required min="2020" max="2030">
                    </div>

                    <div class="form-group">
                        <label for="regAddress">Address</label>
                        <textarea id="regAddress" placeholder="Enter your address" rows="2"></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary">Register</button>

                    <p style="text-align: center; margin-top: 15px; color: #7f8c8d;">
                        <small>Already have an account? <a href="#" onclick="showLoginForm(); return false;" style="color: #3498db; text-decoration: underline;">Login here</a></small>
                    </p>
                </form>

                <!-- Admin Login Form -->
                <form id="adminLoginForm" class="login-form">
                    <h2 style="margin-bottom: 30px; color: #2c3e50;">Admin Login</h2>
                    
                    <div class="form-group">
                        <label for="adminEmail">Email</label>
                        <input type="email" id="adminEmail" placeholder="admin@university.edu" required>
                    </div>

                    <div class="form-group">
                        <label for="adminPassword">Password</label>
                        <input type="password" id="adminPassword" placeholder="Enter your password" required>
                    </div>

                    <button type="submit" class="btn btn-primary">Login</button>

                    <p style="text-align: center; margin-top: 15px; color: #7f8c8d;">
                        <small>Need an account? <a href="#" onclick="showAdminRegisterForm(); return false;" style="color: #3498db; text-decoration: underline;">Register here</a></small>
                    </p>

                    <p style="text-align: center; margin-top: 10px; color: #7f8c8d;">
                        <small>Demo: admin@university.edu / admin123</small>
                    </p>
                </form>

                <!-- Admin Registration Form -->
                <form id="adminRegisterForm" class="login-form" style="display: none;">
                    <h2 style="margin-bottom: 20px; color: #2c3e50;">Admin Registration</h2>
                    
                    <div class="form-group">
                        <label for="regAdminName">Full Name *</label>
                        <input type="text" id="regAdminName" placeholder="John Doe" required>
                    </div>

                    <div class="form-group">
                        <label for="regAdminUsername">Username *</label>
                        <input type="text" id="regAdminUsername" placeholder="johndoe" required>
                    </div>

                    <div class="form-group">
                        <label for="regAdminEmail">Email *</label>
                        <input type="email" id="regAdminEmail" placeholder="admin@university.edu" required>
                    </div>

                    <div class="form-group">
                        <label for="regAdminPassword">Password *</label>
                        <input type="password" id="regAdminPassword" placeholder="Minimum 6 characters" required minlength="6">
                    </div>

                    <div class="form-group">
                        <label for="regAdminPhone">Phone</label>
                        <input type="tel" id="regAdminPhone" placeholder="555-1234" maxlength="10" inputmode="numeric" pattern="[0-9]{0,10}" title="Up to 10 digits" />
                    </div>

                    <div class="form-group">
                        <label for="regAdminRole">Role *</label>
                        <select id="regAdminRole" required>
                            <option value="">Select Role</option>
                            <option value="ADMIN">Admin</option>
                            <option value="SUPER_ADMIN">Super Admin</option>
                        </select>
                    </div>

                    <button type="submit" class="btn btn-primary">Register</button>

                    <p style="text-align: center; margin-top: 15px; color: #7f8c8d;">
                        <small>Already have an account? <a href="#" onclick="showAdminLoginForm(); return false;" style="color: #3498db; text-decoration: underline;">Login here</a></small>
                    </p>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Tab switching
        function switchTab(tab) {
            const studentLoginForm = document.getElementById('studentLoginForm');
            const studentRegisterForm = document.getElementById('studentRegisterForm');
            const adminLoginForm = document.getElementById('adminLoginForm');
            const adminRegisterForm = document.getElementById('adminRegisterForm');
            const tabButtons = document.querySelectorAll('.tab-btn');

            tabButtons.forEach(btn => btn.classList.remove('active'));

            // Hide all forms
            studentLoginForm.style.display = 'none';
            studentRegisterForm.style.display = 'none';
            adminLoginForm.style.display = 'none';
            adminRegisterForm.style.display = 'none';

            if (tab === 'student') {
                studentLoginForm.classList.add('active');
                studentLoginForm.style.display = 'block';
                tabButtons[0].classList.add('active');
            } else {
                adminLoginForm.classList.add('active');
                adminLoginForm.style.display = 'block';
                tabButtons[1].classList.add('active');
            }

            hideAlert();
        }

        // Show alert
        function showAlert(message, type = 'danger') {
            const alertBox = document.getElementById('alertBox');
            alertBox.textContent = message;
            alertBox.className = `alert alert-${type} show`;
            setTimeout(() => hideAlert(), 5000);
        }

        // Hide alert
        function hideAlert() {
            const alertBox = document.getElementById('alertBox');
            alertBox.classList.remove('show');
        }

        // Student Login
        document.getElementById('studentLoginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('studentEmail').value;
            const password = document.getElementById('studentPassword').value;

            try {
                const response = await fetch('/api/auth/student/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('Login successful! Redirecting...', 'success');
                    setTimeout(() => {
                        window.location.href = '/student-dashboard';
                    }, 1000);
                } else {
                    showAlert(data.message || 'Login failed');
                }
            } catch (error) {
                showAlert('An error occurred. Please try again.');
                console.error('Login error:', error);
            }
        });

        // Admin Login
        document.getElementById('adminLoginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;

            try {
                const response = await fetch('/api/auth/admin/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('Login successful! Redirecting...', 'success');
                    setTimeout(() => {
                        window.location.href = '/admin-dashboard';
                    }, 1000);
                } else {
                    showAlert(data.message || 'Login failed');
                }
            } catch (error) {
                showAlert('An error occurred. Please try again.');
                console.error('Login error:', error);
            }
        });

        // Admin Registration
        document.getElementById('adminRegisterForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                fullName: document.getElementById('regAdminName').value.trim(),
                username: document.getElementById('regAdminUsername').value.trim(),
                email: document.getElementById('regAdminEmail').value.trim(),
                password: document.getElementById('regAdminPassword').value,
                phone: document.getElementById('regAdminPhone').value.trim() || null,
                role: document.getElementById('regAdminRole').value
            };

            // Normalize phone: digits only
            if (formData.phone) {
                const digits = formData.phone.replace(/\D/g, '');
                if (digits.length > 10) {
                    showAlert('Phone number must be at most 10 digits.', 'danger');
                    return;
                }
                formData.phone = digits.length === 0 ? null : digits;
            }

            // Validation
            if (!formData.role) {
                showAlert('Please select a role', 'danger');
                return;
            }

            try {
                const response = await fetch('/api/auth/admin/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('Admin registration successful! Please login with your credentials.', 'success');
                    setTimeout(() => {
                        showAdminLoginForm();
                        document.getElementById('adminEmail').value = formData.email;
                    }, 2000);
                } else {
                    showAlert(data.message || 'Registration failed');
                }
            } catch (error) {
                showAlert('An error occurred. Please try again.');
                console.error('Admin registration error:', error);
            }
        });

        // Show/Hide Registration Form
        function showRegisterForm() {
            document.getElementById('studentLoginForm').style.display = 'none';
            document.getElementById('studentRegisterForm').style.display = 'block';
            hideAlert();
            loadDepartments();
            // Set max DOB to ensure age > 17 (i.e., at least 18 years old)
            const dobInput = document.getElementById('regDOB');
            if (dobInput) {
                const today = new Date();
                const year = today.getFullYear() - 18; // allow 18 years and older
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                dobInput.max = `${year}-${month}-${day}`;
            }
        }

        function showLoginForm() {
            document.getElementById('studentLoginForm').style.display = 'block';
            document.getElementById('studentRegisterForm').style.display = 'none';
            hideAlert();
        }

        function showAdminRegisterForm() {
            document.getElementById('adminLoginForm').style.display = 'none';
            document.getElementById('adminRegisterForm').style.display = 'block';
            hideAlert();
        }

        function showAdminLoginForm() {
            document.getElementById('adminLoginForm').style.display = 'block';
            document.getElementById('adminRegisterForm').style.display = 'none';
            hideAlert();
        }

        // Load Departments
        async function loadDepartments() {
            try {
                const response = await fetch('/api/courses/public/departments');
                const data = await response.json();

                if (data.success) {
                    const select = document.getElementById('regDepartment');
                    select.innerHTML = '<option value="">Select Department</option>';
                    data.departments.forEach(dept => {
                        const option = document.createElement('option');
                        option.value = dept.department_id;
                        option.textContent = dept.department_name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading departments:', error);
            }
        }

        // Student Registration
        document.getElementById('studentRegisterForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                studentNumber: document.getElementById('regStudentNumber').value.trim(),
                firstName: document.getElementById('regFirstName').value.trim(),
                lastName: document.getElementById('regLastName').value.trim(),
                email: document.getElementById('regEmail').value.trim(),
                password: document.getElementById('regPassword').value,
                phone: document.getElementById('regPhone').value.trim() || null,
                dateOfBirth: document.getElementById('regDOB').value || null,
                gender: document.getElementById('regGender').value || null,
                address: document.getElementById('regAddress').value.trim() || null,
                departmentId: document.getElementById('regDepartment').value,
                enrollmentYear: parseInt(document.getElementById('regYear').value)
            };

            // Normalize and validate phone: allow up to 10 digits
            if (formData.phone) {
                const digits = formData.phone.replace(/\D/g, '');
                if (digits.length > 10) {
                    showAlert('Phone number must be at most 10 digits.', 'danger');
                    return;
                }
                formData.phone = digits.length === 0 ? null : digits;
            }

            // Client-side DOB validation: require age >= 18
            if (formData.dateOfBirth) {
                const dob = new Date(formData.dateOfBirth);
                const today = new Date();
                let age = today.getFullYear() - dob.getFullYear();
                const m = today.getMonth() - dob.getMonth();
                if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) {
                    age--;
                }
                if (age < 18) {
                    showAlert('You must be at least 18 years old to register.', 'danger');
                    return;
                }
            } else {
                showAlert('Please enter your date of birth.', 'danger');
                return;
            }

            // Validation
            if (!formData.departmentId) {
                showAlert('Please select a department', 'danger');
                return;
            }

            try {
                const response = await fetch('/api/auth/student/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('Registration successful! Please login with your credentials.', 'success');
                    setTimeout(() => {
                        showLoginForm();
                        document.getElementById('studentEmail').value = formData.email;
                    }, 2000);
                } else {
                    showAlert(data.message || 'Registration failed');
                }
            } catch (error) {
                showAlert('An error occurred. Please try again.');
                console.error('Registration error:', error);
            }
        });

        // Check if already logged in
        async function checkSession() {
            try {
                const response = await fetch('/api/auth/session');
                const data = await response.json();

                if (data.authenticated) {
                    if (data.user.type === 'student') {
                        window.location.href = '/student-dashboard';
                    } else if (data.user.type === 'admin') {
                        window.location.href = '/admin-dashboard';
                    }
                }
            } catch (error) {
                console.error('Session check error:', error);
            }
        }

        checkSession();

        // Ensure regPhone contains digits only (strip non-digits on input/paste)
        (function() {
            const phoneInput = document.getElementById('regPhone');
            if (phoneInput) {
                phoneInput.addEventListener('input', (e) => {
                    const cleaned = e.target.value.replace(/\D/g, '').slice(0, 10);
                    if (e.target.value !== cleaned) e.target.value = cleaned;
                });

                phoneInput.addEventListener('paste', (e) => {
                    const paste = (e.clipboardData || window.clipboardData).getData('text');
                    if (!paste) return;
                    const cleaned = paste.replace(/\D/g, '').slice(0, 10);
                    e.preventDefault();
                    const start = phoneInput.selectionStart || 0;
                    const end = phoneInput.selectionEnd || 0;
                    const val = phoneInput.value;
                    const newVal = (val.slice(0, start) + cleaned + val.slice(end)).replace(/\D/g, '').slice(0, 10);
                    phoneInput.value = newVal;
                });
            }

            // Admin phone
            const adminPhoneInput = document.getElementById('regAdminPhone');
            if (adminPhoneInput) {
                adminPhoneInput.addEventListener('input', (e) => {
                    const cleaned = e.target.value.replace(/\D/g, '').slice(0, 10);
                    if (e.target.value !== cleaned) e.target.value = cleaned;
                });

                adminPhoneInput.addEventListener('paste', (e) => {
                    const paste = (e.clipboardData || window.clipboardData).getData('text');
                    if (!paste) return;
                    const cleaned = paste.replace(/\D/g, '').slice(0, 10);
                    e.preventDefault();
                    const start = adminPhoneInput.selectionStart || 0;
                    const end = adminPhoneInput.selectionEnd || 0;
                    const val = adminPhoneInput.value;
                    const newVal = (val.slice(0, start) + cleaned + val.slice(end)).replace(/\D/g, '').slice(0, 10);
                    adminPhoneInput.value = newVal;
                });
            }
        })();
    </script>
</body>
</html>
